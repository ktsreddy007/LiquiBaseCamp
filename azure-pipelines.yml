# Trigger pipeline ONLY when code is pushed to main / master
trigger: none 
#  branches:
#    include:
#      - main
pool:
  name: Self-Hosted
  demands:
    - agent.name -equals WSL_Agent
parameters:
  - name: targetEnvironment
    type: string
    values:
      - Dev
      - QA
      - TRAIN
      - STAGE
      - PROD    

# Global pipeline variable
variables:
- ${{ if eq(parameters.targetEnvironment, 'Dev') }}:
  - template: templates/variables-dev.yml
- ${{ if eq(parameters.targetEnvironment, 'QA') }}:
  - template: templates/variables-qa.yml
- ${{ if eq(parameters.targetEnvironment, 'STAGE') }}:
  - template: templates/variables-stage.yml
- ${{ if eq(parameters.targetEnvironment, 'PROD') }}:
  - template: templates/variables-prod.yml 

stages:
# ============================
# Stage 1: Setup Environment
# ============================
- stage: SetupStage
  displayName: "Setup Environment"
  jobs:
    - job: SetupJob
      steps:
        - checkout: self
        - template: templates/setup-env.yml

# ============================
# Stage 2: DB Connection Check
# ============================
- stage: DBConnectionStage
  displayName: "DB Connection Check"
  dependsOn: SetupStage
  jobs:
    - job: DBConnectionJob
      steps:
        - checkout: self
        - template: templates/db-connection-check.yml
# ============================
# Stage 3: Pre-Deployment Checks (SQLFluff + OPA)
# ============================
- stage: PreDeployChecks
  displayName: "Pre-Deployment Checks"
  dependsOn: DBConnectionStage
  jobs:
    - job: SQLFluffJob
      displayName: "SQLFluff Lint"
      steps:
        - checkout: self
        - script: |
            echo "Activating Python venv..."
            source ~/venvs/sqlfluff-env/bin/activate
            mkdir -p $(Build.ArtifactStagingDirectory)/sqlfluff
            echo "Linting all SQL files"
            which sqlfluff
            sqlfluff --version
            ls -l DML/Migrations/Tables
            echo "Checking sqlfluff version and location:"
            sqlfluff lint DML/Migrations/Tables/*.sql --dialect mssql --format json > $(Build.ArtifactStagingDirectory)/sqlfluff/sqlfluff-report.json
            deactivate
          displayName: "SQLFluff Lint"
        - publish: $(Build.ArtifactStagingDirectory)/sqlfluff
          artifact: SQLFluffReports  
#    - job: OPAJob
#      displayName: "OPA Policy Check"
#      dependsOn: SQLFluffJob
#      steps:
#        - checkout: self  
#        - script: |
#            echo "Running OPA policy check..."
#            mkdir -p $(Build.ArtifactStagingDirectory)/opa
#            OPA_DIR="$(Build.SourcesDirectory)/opa"
#            echo "$OPA_DIR"
#            opa eval -i "$OPA_DIR/input.json" -d "$OPA_DIR/policy.rego" 'data.example.deny' --format json > $(Build.ArtifactStagingDirectory)/opa/opa-report.json
#          displayName: "OPA Policy Evaluation"
#        - publish: $(Build.ArtifactStagingDirectory)/opa
#          artifact: OPAReports  
# ============================
# Stage 4: Liquibase Validate
# ============================
- stage: ValidateStage
  displayName: "Liquibase Validate"
  dependsOn: PreDeployChecks
  jobs:
    - job: ValidateJob
      steps:
        - checkout: self
        - template: templates/liquibase-validate.yml
# ============================
# Stage 5: Liquibase UpdateSQL (Dry Run)
# ============================
- stage: UpdateSQLStage
  displayName: "Liquibase UpdateSQL"
  dependsOn: ValidateStage
  jobs:
    - job: UpdateSQLJob
      steps:
        - checkout: self 
        - template: templates/liquibase-update-sql.yml
# ============================
# Stage 6: Approval
# ============================
- stage: ApprovalStage
  displayName: "Manual Approval Before Deploy"
  dependsOn: UpdateSQLStage
  jobs:
    - job: ApprovalJob
      pool: server
      steps:
        - task: ManualValidation@0
          timeoutInMinutes: 1440
          inputs:
            notifyUsers: ''  
            instructions: >
              Please review UpdateSQL output and approve Liquibase deployment to the target database.
            onTimeout: reject
# ============================
# Stage 7: Liquibase Deploy
# ============================
- stage: DeployStage
  displayName: "Liquibase Deploy"
  dependsOn: ApprovalStage
  jobs:
    - job: DeployJob
      steps:
        - checkout: self
        - template: templates/liquibase-deploy.yml

