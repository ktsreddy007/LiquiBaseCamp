# DB Connection Check Template
steps:
  - script: |
      set -euo pipefail
      echo "=== DB CONNECTION CHECK ==="
      echo "[DEBUG] DB_URL= $DB_URL"
      echo "[DEBUG] DB_USERNAME=$DB_USERNAME"
      echo "[DEBUG] DB_PASSWORD is set? ${DB_PASSWORD:+yes}"
      if [ -z "$DB_URL" ] || [ -z "$DB_USERNAME" ] || [ -z "$DB_PASSWORD" ]; then
        echo "ERROR: One or more DB variables are not set (DB_URL/DB_USERNAME/DB_PASSWORD)"
        exit 1
      fi
      echo "[DEBUG] Checking for MSSQL JDBC driver in Liquibase lib"
      ls -la "$(LIQUIBASE_HOME)"/internal/lib | grep -i mssql || echo "WARN: mssql driver not found"
      echo "[DEBUG] Changelog exists?"
      ls -l DDL/changelog/master.xml || ls -l DML/changelog/master.xml || true
      liquibase status --verbose --defaultsFile=config/liquibase.properties --driver=com.microsoft.sqlserver.jdbc.SQLServerDriver --username="$DB_USERNAME" --password="$DB_PASSWORD" --url="$DB_URL"
      echo "[DEBUG] DB_URL: $DB_URL"
      echo "Database connection successful"
    env:
      DB_URL: $(DB_URL)
      DB_USERNAME: $(DB_USERNAME)
      DB_PASSWORD: $(DB_PASSWORD)