steps:
  - script: |
      set -euo pipefail
      echo "=== DB CONNECTION CHECK ==="
      # Detect changelog path dynamically
      if [ -f "DML/changelog/master.xml" ]; then
          CHANGELOG="DML/changelog/master.xml"
      elif [ -f "DDL/changelog/master.xml" ]; then
          CHANGELOG="DDL/changelog/master.xml"
      else
          echo "ERROR: Changelog file not found"
          exit 1
      fi
      echo "Using changelog file: $CHANGELOG"
      # Verify JDBC driver
      if find "$LIQUIBASE_HOME" -name "*.jar" -exec jar tf {} \; | grep -q "com/microsoft/sqlserver/jdbc/SQLServerDriver.class"; then
        echo "MSSQL JDBC driver found"
      else
        echo "ERROR: MSSQL JDBC driver not found. Exiting."
        exit 1
      fi
      
      # Check DB connection
      liquibase status \
        --defaultsFile=config/liquibase.properties \
        --changeLogFile=$CHANGELOG \
        --username="$DB_USERNAME" \
        --password="$DB_PASSWORD" \
        --url="$DB_URL"
      echo "Database connection successful."
    displayName: "DB Connection Check"
    env:
      DB_URL: $(DB_URL)
      DB_USERNAME: $(DB_USERNAME)
      DB_PASSWORD: $(DB_PASSWORD)
      LIQUIBASE_HOME: $(LIQUIBASE_HOME)